<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Hub</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0a0a0f;--surface:#13131a;--surface2:#1c1c26;--border:#2a2a3a;--accent:#7c6aff;--accent2:#ff6a9a;--accent3:#6affd4;--text:#e8e8f0;--text-dim:#8888a0;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;overflow:hidden;}
  #sidebar{width:270px;min-width:270px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:20px 0;overflow:hidden;}
  .logo{padding:0 20px 16px;border-bottom:1px solid var(--border);margin-bottom:14px;}
  .logo h1{font-size:21px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
  .logo p{font-size:10px;color:var(--text-dim);font-family:'Space Mono',monospace;margin-top:2px;}
  .slabel{font-size:10px;font-weight:700;letter-spacing:2px;color:var(--text-dim);padding:0 20px 8px;text-transform:uppercase;}
  .bot-list{padding:0 10px;flex:1;overflow-y:auto;}
  .bot-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:10px;cursor:pointer;transition:all .2s;margin-bottom:3px;border:1px solid transparent;}
  .bot-item:hover{background:var(--surface2);}
  .bot-item.active{background:var(--surface2);border-color:var(--border);}
  .bot-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
  .bot-info{overflow:hidden;flex:1;}
  .bot-name{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .bot-mtag{font-size:10px;color:var(--text-dim);font-family:'Space Mono',monospace;}
  .bot-acts{display:flex;gap:3px;opacity:0;transition:opacity .2s;flex-shrink:0;}
  .bot-item:hover .bot-acts{opacity:1;}
  .bab{width:22px;height:22px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--text-dim);cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
  .bab:hover{border-color:var(--accent);color:var(--accent);}
  .add-btn{margin:8px 10px;padding:9px;border:1px dashed var(--border);border-radius:10px;background:transparent;color:var(--text-dim);cursor:pointer;font-family:'Syne',sans-serif;font-size:12px;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:6px;}
  .add-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent)11;}
  .api-sec{padding:12px 10px 0;border-top:1px solid var(--border);overflow-y:auto;max-height:260px;}
  .arow{margin-bottom:7px;}
  .alabel{font-size:10px;color:var(--text-dim);font-family:'Space Mono',monospace;margin-bottom:3px;display:block;}
  .ainput{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:7px 10px;color:var(--text);font-family:'Space Mono',monospace;font-size:10px;outline:none;transition:border-color .2s;}
  .ainput:focus{border-color:var(--accent);}
  .save-btn{width:100%;padding:8px;background:var(--accent);border:none;border-radius:8px;color:white;font-family:'Syne',sans-serif;font-weight:700;font-size:12px;cursor:pointer;transition:opacity .2s;margin-top:6px;margin-bottom:8px;}
  .save-btn:hover{opacity:.85;}
  #main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
  .chat-hdr{padding:14px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;background:var(--surface);}
  .hdr-icon{width:38px;height:38px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:19px;}
  .hdr-info h2{font-size:15px;font-weight:700;}
  .hdr-info p{font-size:11px;color:var(--text-dim);font-family:'Space Mono',monospace;}
  .hdr-acts{margin-left:auto;display:flex;gap:8px;align-items:center;}
  .msel-wrap{position:relative;}
  .msel{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:6px 26px 6px 10px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;font-weight:600;cursor:pointer;outline:none;appearance:none;transition:border-color .2s;max-width:200px;}
  .msel:focus{border-color:var(--accent);}
  .msel-wrap::after{content:'‚ñæ';position:absolute;right:8px;top:50%;transform:translateY(-50%);color:var(--text-dim);pointer-events:none;font-size:11px;}
  .hdr-btn{padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-family:'Syne',sans-serif;font-size:12px;cursor:pointer;transition:all .2s;}
  .hdr-btn:hover{border-color:var(--accent2);color:var(--accent2);}
  #messages{flex:1;overflow-y:auto;padding:22px;display:flex;flex-direction:column;gap:14px;scroll-behavior:smooth;}
  #messages::-webkit-scrollbar{width:4px;}
  #messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
  .msg{display:flex;gap:10px;animation:fu .3s ease;}
  .msg.user{flex-direction:row-reverse;align-self:flex-end;max-width:75%;}
  .msg.bot{align-self:flex-start;max-width:85%;}
  @keyframes fu{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .mavatar{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;margin-top:2px;}
  .mbubble{padding:11px 15px;border-radius:13px;font-size:13.5px;line-height:1.65;}
  .msg.user .mbubble{background:#1e1a3a;border:1px solid var(--accent)44;border-bottom-right-radius:3px;}
  .msg.bot .mbubble{background:#131320;border:1px solid var(--border);border-bottom-left-radius:3px;}
  .mbubble pre{background:#0d0d15;border:1px solid var(--border);border-radius:8px;padding:12px;overflow-x:auto;margin:8px 0;font-family:'Space Mono',monospace;font-size:12px;line-height:1.5;white-space:pre-wrap;word-break:break-word;}
  .mbubble code{font-family:'Space Mono',monospace;font-size:12px;background:#0d0d15;padding:2px 5px;border-radius:4px;}
  .mbubble pre code{background:none;padding:0;}
  .mbubble strong{color:var(--accent3);}
  .mbubble ul,.mbubble ol{padding-left:20px;margin:6px 0;}
  .mbubble li{margin-bottom:3px;}
  .mbubble h3,.mbubble h4{color:var(--accent3);margin:8px 0 4px;}
  .typing{display:flex;gap:4px;padding:13px 15px;background:#131320;border:1px solid var(--border);border-radius:13px;border-bottom-left-radius:3px;width:fit-content;}
  .tdot{width:6px;height:6px;border-radius:50%;background:var(--text-dim);animation:b 1.2s infinite;}
  .tdot:nth-child(2){animation-delay:.2s}.tdot:nth-child(3){animation-delay:.4s}
  @keyframes b{0%,60%,100%{transform:translateY(0);opacity:.4}30%{transform:translateY(-6px);opacity:1}}
  .welcome{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px;gap:10px;}
  .welcome-icon{font-size:46px;margin-bottom:6px;}
  .welcome h2{font-size:22px;font-weight:800;}
  .welcome p{color:var(--text-dim);font-size:13px;max-width:380px;line-height:1.6;}
  .input-area{padding:14px 22px 18px;border-top:1px solid var(--border);background:var(--surface);}
  .input-wrap{display:flex;gap:10px;background:var(--bg);border:1px solid var(--border);border-radius:13px;padding:9px 13px;transition:border-color .2s;}
  .input-wrap:focus-within{border-color:var(--accent)88;}
  #ui{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:'Syne',sans-serif;font-size:14px;resize:none;max-height:120px;line-height:1.5;}
  #ui::placeholder{color:var(--text-dim);}
  #sb{width:34px;height:34px;border-radius:9px;background:var(--accent);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;align-self:flex-end;transition:all .2s;}
  #sb:hover{opacity:.85;transform:scale(1.05);}
  #sb:disabled{opacity:.4;cursor:not-allowed;transform:none;}
  #sb svg{width:15px;height:15px;fill:white;}
  .input-hint{font-size:10px;color:var(--text-dim);text-align:center;margin-top:6px;font-family:'Space Mono',monospace;}
  .overlay{position:fixed;inset:0;background:#00000088;backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:100;opacity:0;pointer-events:none;transition:opacity .2s;}
  .overlay.show{opacity:1;pointer-events:all;}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:26px;width:460px;max-width:92vw;max-height:90vh;overflow-y:auto;transform:scale(.95);transition:transform .2s;}
  .overlay.show .modal{transform:scale(1);}
  .modal h3{font-size:17px;font-weight:800;margin-bottom:18px;}
  .fg{margin-bottom:13px;}
  .fl{display:block;font-size:11px;font-weight:700;margin-bottom:5px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px;}
  .fi,.fs,.fta{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:9px;padding:9px 11px;color:var(--text);font-family:'Syne',sans-serif;font-size:13px;outline:none;transition:border-color .2s;}
  .fta{resize:vertical;min-height:90px;line-height:1.5;}
  .fi:focus,.fs:focus,.fta:focus{border-color:var(--accent);}
  .fs option,.fs optgroup{background:var(--surface);color:var(--text);}
  .emoji-grid{display:flex;flex-wrap:wrap;gap:5px;margin-top:5px;}
  .ebtn{width:34px;height:34px;border-radius:7px;border:1px solid var(--border);background:var(--bg);cursor:pointer;font-size:17px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
  .ebtn:hover,.ebtn.sel{border-color:var(--accent);background:var(--accent)22;}
  .color-grid{display:flex;gap:7px;flex-wrap:wrap;margin-top:5px;}
  .cbtn{width:26px;height:26px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:transform .15s;}
  .cbtn:hover{transform:scale(1.15);}
  .cbtn.sel{border-color:white;transform:scale(1.1);}
  .macts{display:flex;gap:8px;margin-top:18px;justify-content:flex-end;}
  .bcncl{padding:9px 18px;border-radius:9px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-family:'Syne',sans-serif;font-weight:600;font-size:13px;cursor:pointer;transition:all .2s;}
  .bcncl:hover{border-color:var(--text-dim);color:var(--text);}
  .bsub{padding:9px 22px;border-radius:9px;border:none;background:var(--accent);color:white;font-family:'Syne',sans-serif;font-weight:700;font-size:13px;cursor:pointer;transition:opacity .2s;}
  .bsub:hover{opacity:.85;}
  .toast{position:fixed;bottom:22px;right:22px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:11px 18px;font-size:13px;font-weight:600;z-index:200;transform:translateY(16px);opacity:0;transition:all .3s;}
  .toast.show{transform:translateY(0);opacity:1;}
  .toast.ok{border-color:var(--accent3)88;color:var(--accent3);}
  .toast.err{border-color:var(--accent2)88;color:var(--accent2);}
  .bot-list::-webkit-scrollbar{width:3px;}
  .bot-list::-webkit-scrollbar-thumb{background:var(--border);}
  .modal::-webkit-scrollbar{width:4px;}
  .modal::-webkit-scrollbar-thumb{background:var(--border);}
</style>
</head>
<body>
<div id="sidebar">
  <div class="logo"><h1>‚ö° AI Hub</h1><p>your personal ai workspace</p></div>
  <div class="slabel">Bots c·ªßa b·∫°n</div>
  <div class="bot-list" id="botList"></div>
  <button class="add-btn" onclick="openModal()">Ôºã T·∫°o bot m·ªõi</button>
  <div class="api-sec">
    <div class="slabel" style="padding:0 10px 8px">API Keys</div>
    <div class="arow"><label class="alabel">üü£ Claude (Anthropic)</label><input class="ainput" type="password" id="kc" placeholder="sk-ant-api03-..."/></div>
    <div class="arow"><label class="alabel">üü¢ OpenAI (ChatGPT)</label><input class="ainput" type="password" id="ko" placeholder="sk-..."/></div>
    <div class="arow"><label class="alabel">üîµ Gemini (Google)</label><input class="ainput" type="password" id="kg" placeholder="AIza..."/></div>
    <div class="arow"><label class="alabel">ü©∑ Perplexity</label><input class="ainput" type="password" id="kp" placeholder="pplx-..."/></div>
    <button class="save-btn" onclick="saveKeys()">üíæ L∆∞u API Keys</button>
  </div>
</div>
<div id="main">
  <div class="chat-hdr">
    <div class="hdr-icon" id="hIcon" style="background:#1c1c26">ü§ñ</div>
    <div class="hdr-info"><h2 id="hName">Ch·ªçn m·ªôt bot</h2><p id="hModel">ƒë·ªÉ b·∫Øt ƒë·∫ßu chat</p></div>
    <div class="hdr-acts">
      <div class="msel-wrap" id="mselWrap" style="display:none">
        <select class="msel" id="msel" onchange="changeModel(this.value)"></select>
      </div>
      <button class="hdr-btn" onclick="clearChat()">üóë X√≥a chat</button>
    </div>
  </div>
  <div id="messages">
    <div class="welcome">
      <div class="welcome-icon">‚ö°</div>
      <h2>AI Hub c·ªßa b·∫°n</h2>
      <p>Ch·ªçn bot t·ª´ sidebar ho·∫∑c t·∫°o bot m·ªõi v·ªõi system prompt v√† model ri√™ng.</p>
    </div>
  </div>
  <div class="input-area">
    <div class="input-wrap">
      <textarea id="ui" placeholder="Nh·∫Øn tin..." rows="1" onkeydown="hk(event)" oninput="ar(this)"></textarea>
      <button id="sb" onclick="send()"><svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg></button>
    </div>
    <div class="input-hint">Enter ƒë·ªÉ g·ª≠i ¬∑ Shift+Enter xu·ªëng d√≤ng</div>
  </div>
</div>
<div class="overlay" id="ov">
  <div class="modal">
    <h3 id="mTitle">‚ú® T·∫°o Bot M·ªõi</h3>
    <div class="fg"><label class="fl">T√™n bot</label><input class="fi" id="bName" placeholder="Vd: Email Bot, MC Bot..."/></div>
    <div class="fg"><label class="fl">Icon</label><div class="emoji-grid" id="eg"></div></div>
    <div class="fg"><label class="fl">M√†u s·∫Øc</label><div class="color-grid" id="cg"></div></div>
    <div class="fg">
      <label class="fl">Model AI</label>
      <select class="fs" id="bModel">
        <optgroup label="üü£ Claude (Anthropic)">
          <option value="claude-sonnet">claude-3-5-sonnet ‚Äî Th√¥ng minh, c√¢n b·∫±ng</option>
          <option value="claude-haiku">claude-3-haiku ‚Äî Nhanh & nh·∫π</option>
          <option value="claude-opus">claude-3-opus ‚Äî M·∫°nh nh·∫•t</option>
        </optgroup>
        <optgroup label="üü¢ OpenAI (ChatGPT)">
          <option value="gpt-4o">gpt-4o ‚Äî Flagship</option>
          <option value="gpt-4o-mini">gpt-4o-mini ‚Äî Nhanh & r·∫ª</option>
          <option value="gpt-4-turbo">gpt-4-turbo ‚Äî M·∫°nh</option>
          <option value="o1-mini">o1-mini ‚Äî Suy lu·∫≠n logic</option>
        </optgroup>
        <optgroup label="üîµ Gemini (Google)">
          <option value="gemini-2.0-flash">gemini-2.0-flash ‚Äî M·ªõi nh·∫•t, nhanh</option>
          <option value="gemini-1.5-pro">gemini-1.5-pro ‚Äî M·∫°nh nh·∫•t</option>
          <option value="gemini-1.5-flash">gemini-1.5-flash ‚Äî C√¢n b·∫±ng</option>
        </optgroup>
        <optgroup label="ü©∑ Perplexity (Search AI)">
          <option value="sonar-large">sonar-large ‚Äî T√¨m ki·∫øm th·ª±c</option>
          <option value="sonar-small">sonar-small ‚Äî T√¨m ki·∫øm nhanh</option>
        </optgroup>
      </select>
    </div>
    <div class="fg"><label class="fl">System Prompt</label><textarea class="fta" id="bPrompt" placeholder="M√¥ t·∫£ vai tr√≤ bot. Vd: B·∫°n l√† tr·ª£ l√Ω so·∫°n email chuy√™n nghi·ªáp..."></textarea></div>
    <div class="macts">
      <button class="bcncl" onclick="closeModal()">H·ªßy</button>
      <button class="bsub" id="mBtn" onclick="submitBot()">T·∫°o Bot ‚ú®</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>
<script>
// ‚îÄ‚îÄ PROXY URL ‚îÄ‚îÄ
const PROXY = 'https://hub.danhrfo.workers.dev';

const MODELS={
  'claude-sonnet':{l:'Claude 3.5 Sonnet',p:'claude'},
  'claude-haiku':{l:'Claude 3 Haiku',p:'claude'},
  'claude-opus':{l:'Claude 3 Opus',p:'claude'},
  'gpt-4o':{l:'GPT-4o',p:'openai'},
  'gpt-4o-mini':{l:'GPT-4o mini',p:'openai'},
  'gpt-4-turbo':{l:'GPT-4 Turbo',p:'openai'},
  'o1-mini':{l:'o1-mini',p:'openai'},
  'gemini-2.0-flash':{l:'Gemini 2.0 Flash',p:'gemini'},
  'gemini-1.5-pro':{l:'Gemini 1.5 Pro',p:'gemini'},
  'gemini-1.5-flash':{l:'Gemini 1.5 Flash',p:'gemini'},
  'sonar-large':{l:'Perplexity Sonar L',p:'perplexity'},
  'sonar-small':{l:'Perplexity Sonar S',p:'perplexity'},
};
const EMOJIS=['üìß','üé§','üíª','üìä','üé®','üìù','üîç','üí°','üöÄ','‚ö°','üéØ','üß†','üåê','üì±','üé¨','üìö','üíº','üõ†Ô∏è','‚ú®','ü§ñ','üè®','üçΩÔ∏è','‚úàÔ∏è','üí∞','üì£','üé™','üé≠','üèÜ'];
const COLORS=['#7c6aff','#ff6a9a','#6affd4','#ffd76a','#ff8c6a','#6ab4ff','#c26aff','#6aff8c','#ff6a6a','#6affff','#ffb86a','#a8ff6a'];

let bots=JSON.parse(localStorage.getItem('ahb')||'[]');
let keys=JSON.parse(localStorage.getItem('ahk')||'{}');
let cur=null,am=null;
let hist=JSON.parse(localStorage.getItem('ahh')||'{}');
let se='ü§ñ',sc='#7c6aff',loading=false,eid=null;

if(!bots.length){
  bots=[
    {id:1,name:'Email Bot',emoji:'üìß',color:'#6ab4ff',model:'claude-sonnet',prompt:'B·∫°n l√† tr·ª£ l√Ω chuy√™n so·∫°n v√† tr·∫£ l·ªùi email chuy√™n nghi·ªáp. Lu√¥n vi·∫øt l·ªãch s·ª±, r√µ r√†ng, ƒë√∫ng ng·ªØ ph√°p ti·∫øng Vi·ªát. Khi so·∫°n email h√£y ƒë∆∞a subject line v√† n·ªôi dung ƒë·∫ßy ƒë·ªß.'},
    {id:2,name:'MC Bot',emoji:'üé§',color:'#ff6a9a',model:'claude-sonnet',prompt:'B·∫°n l√† MC chuy√™n nghi·ªáp, gi·ªèi d·∫´n ch∆∞∆°ng tr√¨nh s·ª± ki·ªán. H·ªó tr·ª£ vi·∫øt k·ªãch b·∫£n, l·ªùi d·∫´n, c√¢u chuy·ªÉn ti·∫øp m∆∞·ª£t m√† v√† l√¥i cu·ªën b·∫±ng ti·∫øng Vi·ªát.'},
    {id:3,name:'Coding Bot',emoji:'üíª',color:'#6affd4',model:'gpt-4o',prompt:'B·∫°n l√† senior software developer. Gi·∫£i th√≠ch code r√µ r√†ng, vi·∫øt code s·∫°ch c√≥ comment, ƒë∆∞a ra best practices. Lu√¥n gi·∫£i th√≠ch t·∫°i sao l√†m nh∆∞ v·∫≠y.'},
    {id:4,name:'T√¨m ki·∫øm',emoji:'üîç',color:'#ffd76a',model:'sonar-large',prompt:'B·∫°n l√† tr·ª£ l√Ω t√¨m ki·∫øm th√¥ng tin. Cung c·∫•p th√¥ng tin ch√≠nh x√°c, c·∫≠p nh·∫≠t v√† c√≥ ngu·ªìn d·∫´n ch·ª©ng r√µ r√†ng.'},
    {id:5,name:'Gemini Pro',emoji:'üåê',color:'#ff8c6a',model:'gemini-1.5-pro',prompt:'B·∫°n l√† tr·ª£ l√Ω ƒëa nƒÉng th√¥ng minh. H·ªó tr·ª£ ph√¢n t√≠ch, t·ªïng h·ª£p th√¥ng tin, vi·∫øt l√°ch v√† gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ ph·ª©c t·∫°p.'},
  ];
  saveBots();
}

function saveBots(){localStorage.setItem('ahb',JSON.stringify(bots));}
function saveHist(){localStorage.setItem('ahh',JSON.stringify(hist));}

function init(){
  renderList();
  if(keys.claude)document.getElementById('kc').value=keys.claude;
  if(keys.openai)document.getElementById('ko').value=keys.openai;
  if(keys.gemini)document.getElementById('kg').value=keys.gemini;
  if(keys.perplexity)document.getElementById('kp').value=keys.perplexity;
  buildEG();buildCG();
}

function saveKeys(){
  keys={claude:document.getElementById('kc').value.trim(),openai:document.getElementById('ko').value.trim(),gemini:document.getElementById('kg').value.trim(),perplexity:document.getElementById('kp').value.trim()};
  localStorage.setItem('ahk',JSON.stringify(keys));
  toast('‚úÖ ƒê√£ l∆∞u API keys!','ok');
}

function renderList(){
  document.getElementById('botList').innerHTML=bots.map(b=>{
    const m=MODELS[b.model]||{};
    return`<div class="bot-item ${cur?.id===b.id?'active':''}" onclick="selBot(${b.id})">
      <div class="bot-icon" style="background:${b.color}22">${b.emoji}</div>
      <div class="bot-info"><div class="bot-name">${b.name}</div><div class="bot-mtag">${m.l||b.model}</div></div>
      <div class="bot-acts">
        <button class="bab" onclick="editBot(event,${b.id})">‚úèÔ∏è</button>
        <button class="bab" onclick="delBot(event,${b.id})">üóë</button>
      </div>
    </div>`;
  }).join('');
}

function selBot(id){
  cur=bots.find(b=>b.id===id);if(!cur)return;
  am=cur.model;updateHdr();renderList();renderMsgs();
}

function updateHdr(){
  if(!cur)return;
  document.getElementById('hIcon').textContent=cur.emoji;
  document.getElementById('hIcon').style.background=cur.color+'22';
  document.getElementById('hName').textContent=cur.name;
  document.getElementById('hModel').textContent=(MODELS[am]||{}).l||am;
  const wrap=document.getElementById('mselWrap');
  const sel=document.getElementById('msel');
  wrap.style.display='block';
  sel.innerHTML=Object.entries(MODELS).map(([k,v])=>`<option value="${k}" ${k===am?'selected':''}>${v.l}</option>`).join('');
}

function changeModel(v){am=v;document.getElementById('hModel').textContent=(MODELS[v]||{}).l||v;toast('üîÑ '+(MODELS[v]||{}).l,'ok');}

function renderMsgs(){
  const c=document.getElementById('messages');
  const h=hist[cur.id]||[];
  if(!h.length){
    c.innerHTML=`<div class="welcome"><div class="welcome-icon">${cur.emoji}</div><h2>${cur.name}</h2><p style="color:var(--accent);font-size:12px;font-family:'Space Mono',monospace;margin-top:2px">${(MODELS[cur.model]||{}).l||cur.model}</p><p style="margin-top:10px;font-size:13px">${cur.prompt.substring(0,120)}...</p></div>`;
    return;
  }
  c.innerHTML=h.map(m=>`<div class="msg ${m.r}">
    <div class="mavatar" style="background:${m.r==='user'?'#1e1a3a':cur.color+'22'}">${m.r==='user'?'üë§':cur.emoji}</div>
    <div class="mbubble">${fmt(m.c)}</div>
  </div>`).join('');
  c.scrollTop=c.scrollHeight;
}

function fmt(t){
  t=t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  t=t.replace(/```(\w*)\n?([\s\S]*?)```/g,(_,l,c)=>`<pre><code>${c.trim()}</code></pre>`);
  t=t.replace(/`([^`\n]+)`/g,'<code>$1</code>');
  t=t.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
  t=t.replace(/\*([^*\n]+)\*/g,'<em>$1</em>');
  t=t.replace(/^#{3} (.+)$/gm,'<h4 style="margin:8px 0 4px;color:var(--accent3)">$1</h4>');
  t=t.replace(/^#{2} (.+)$/gm,'<h3 style="margin:10px 0 5px;color:var(--accent3)">$1</h3>');
  t=t.replace(/^- (.+)$/gm,'<li style="margin-left:16px">$1</li>');
  t=t.replace(/\n/g,'<br>');
  return t;
}

function clearChat(){
  if(!cur)return;
  if(!confirm(`X√≥a l·ªãch s·ª≠ chat c·ªßa "${cur.name}"?`))return;
  hist[cur.id]=[];saveHist();renderMsgs();
}

async function send(){
  if(loading||!cur)return;
  const inp=document.getElementById('ui');
  const txt=inp.value.trim();if(!txt)return;
  inp.value='';inp.style.height='auto';
  if(!hist[cur.id])hist[cur.id]=[];
  hist[cur.id].push({r:'user',c:txt});
  saveHist();renderMsgs();
  const container=document.getElementById('messages');
  const te=document.createElement('div');
  te.className='msg bot';te.id='ty';
  te.innerHTML=`<div class="mavatar" style="background:${cur.color}22">${cur.emoji}</div><div class="typing"><div class="tdot"></div><div class="tdot"></div><div class="tdot"></div></div>`;
  container.appendChild(te);container.scrollTop=container.scrollHeight;
  loading=true;document.getElementById('sb').disabled=true;
  try{
    const rep=await callAPI(am,cur.prompt,hist[cur.id]);
    document.getElementById('ty')?.remove();
    hist[cur.id].push({r:'bot',c:rep});
    saveHist();renderMsgs();
  }catch(err){
    document.getElementById('ty')?.remove();
    hist[cur.id].push({r:'bot',c:'‚ö†Ô∏è L·ªói: '+err.message});
    saveHist();renderMsgs();
    toast('‚ùå '+err.message,'err');
  }
  loading=false;document.getElementById('sb').disabled=false;
  document.getElementById('ui').focus();
}

// ‚îÄ‚îÄ API v·ªõi PROXY ‚îÄ‚îÄ
async function proxyFetch(targetUrl, headers, body){
  const url = `${PROXY}?target=${encodeURIComponent(targetUrl)}`;
  const r = await fetch(url, {method:'POST', headers, body});
  if(!r.ok){
    const e = await r.json().catch(()=>({}));
    const msg = e.error?.message || e.message || `HTTP ${r.status}`;
    throw new Error(msg);
  }
  return r.json();
}

async function callAPI(mk,sys,h){
  const m=MODELS[mk];if(!m)throw new Error('Model kh√¥ng h·ª£p l·ªá');
  const msgs=h.slice(0,-1).map(x=>({role:x.r==='bot'?'assistant':'user',content:x.c}));
  const last=h[h.length-1].c;
  if(m.p==='claude')return callClaude(mk,sys,msgs,last);
  if(m.p==='openai')return callOAI(mk,sys,msgs,last);
  if(m.p==='gemini')return callGemini(mk,sys,msgs,last);
  if(m.p==='perplexity')return callPPX(mk,sys,msgs,last);
  throw new Error('Provider l·ªói');
}

async function callClaude(mk,sys,msgs,last){
  if(!keys.claude)throw new Error('Ch∆∞a nh·∫≠p Claude API key!');
  const mmap={'claude-sonnet':'claude-3-5-sonnet-20241022','claude-haiku':'claude-3-haiku-20240307','claude-opus':'claude-3-opus-20240229'};
  const data = await proxyFetch(
    'https://api.anthropic.com/v1/messages',
    {'Content-Type':'application/json','x-api-key':keys.claude,'anthropic-version':'2023-06-01'},
    JSON.stringify({model:mmap[mk]||mk,max_tokens:2048,system:sys,messages:[...msgs,{role:'user',content:last}]})
  );
  return data.content[0].text;
}

async function callOAI(mk,sys,msgs,last){
  if(!keys.openai)throw new Error('Ch∆∞a nh·∫≠p OpenAI API key!');
  const data = await proxyFetch(
    'https://api.openai.com/v1/chat/completions',
    {'Content-Type':'application/json','Authorization':'Bearer '+keys.openai},
    JSON.stringify({model:mk,messages:[{role:'system',content:sys},...msgs,{role:'user',content:last}]})
  );
  return data.choices[0].message.content;
}

async function callGemini(mk,sys,msgs,last){
  if(!keys.gemini)throw new Error('Ch∆∞a nh·∫≠p Gemini API key!');
  const gmap={'gemini-2.0-flash':'gemini-2.0-flash','gemini-1.5-pro':'gemini-1.5-pro','gemini-1.5-flash':'gemini-1.5-flash'};
  const mn=gmap[mk]||'gemini-1.5-flash';
  const contents=[];
  msgs.forEach(m=>contents.push({role:m.role==='assistant'?'model':'user',parts:[{text:m.content}]}));
  contents.push({role:'user',parts:[{text:last}]});
  const data = await proxyFetch(
    `https://generativelanguage.googleapis.com/v1beta/models/${mn}:generateContent?key=${keys.gemini}`,
    {'Content-Type':'application/json'},
    JSON.stringify({system_instruction:{parts:[{text:sys}]},contents,generationConfig:{maxOutputTokens:2048,temperature:0.7}})
  );
  return data.candidates?.[0]?.content?.parts?.[0]?.text||'Kh√¥ng c√≥ ph·∫£n h·ªìi';
}

async function callPPX(mk,sys,msgs,last){
  if(!keys.perplexity)throw new Error('Ch∆∞a nh·∫≠p Perplexity API key!');
  const pmap={'sonar-large':'llama-3.1-sonar-large-128k-online','sonar-small':'llama-3.1-sonar-small-128k-online'};
  const data = await proxyFetch(
    'https://api.perplexity.ai/chat/completions',
    {'Content-Type':'application/json','Authorization':'Bearer '+keys.perplexity},
    JSON.stringify({model:pmap[mk]||mk,messages:[{role:'system',content:sys},...msgs,{role:'user',content:last}]})
  );
  return data.choices[0].message.content;
}

function buildEG(){document.getElementById('eg').innerHTML=EMOJIS.map(e=>`<button class="ebtn ${e===se?'sel':''}" onclick="selE('${e}')">${e}</button>`).join('');}
function buildCG(){document.getElementById('cg').innerHTML=COLORS.map(c=>`<div class="cbtn ${c===sc?'sel':''}" style="background:${c}" onclick="selC('${c}')"></div>`).join('');}
function selE(e){se=e;buildEG();}
function selC(c){sc=c;buildCG();}

function openModal(id=null){
  eid=id;
  if(id){
    const b=bots.find(x=>x.id===id);if(!b)return;
    document.getElementById('mTitle').textContent='‚úèÔ∏è S·ª≠a Bot';
    document.getElementById('mBtn').textContent='L∆∞u thay ƒë·ªïi';
    document.getElementById('bName').value=b.name;
    document.getElementById('bModel').value=b.model;
    document.getElementById('bPrompt').value=b.prompt;
    se=b.emoji;sc=b.color;
  }else{
    document.getElementById('mTitle').textContent='‚ú® T·∫°o Bot M·ªõi';
    document.getElementById('mBtn').textContent='T·∫°o Bot ‚ú®';
    document.getElementById('bName').value='';
    document.getElementById('bModel').value='claude-sonnet';
    document.getElementById('bPrompt').value='';
    se='ü§ñ';sc='#7c6aff';
  }
  buildEG();buildCG();
  document.getElementById('ov').classList.add('show');
  setTimeout(()=>document.getElementById('bName').focus(),100);
}
function closeModal(){document.getElementById('ov').classList.remove('show');eid=null;}

function submitBot(){
  const name=document.getElementById('bName').value.trim();
  const model=document.getElementById('bModel').value;
  const prompt=document.getElementById('bPrompt').value.trim();
  if(!name){toast('‚ö†Ô∏è Nh·∫≠p t√™n bot nh√©!','err');return;}
  if(!prompt){toast('‚ö†Ô∏è Nh·∫≠p system prompt nh√©!','err');return;}
  if(eid){
    const i=bots.findIndex(b=>b.id===eid);
    if(i>-1){
      bots[i]={...bots[i],name,emoji:se,color:sc,model,prompt};
      if(cur?.id===eid){cur=bots[i];am=model;updateHdr();}
      toast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t '+name,'ok');
    }
  }else{
    const nb={id:Date.now(),name,emoji:se,color:sc,model,prompt};
    bots.push(nb);saveBots();renderList();closeModal();selBot(nb.id);
    toast('‚ú® ƒê√£ t·∫°o '+name,'ok');return;
  }
  saveBots();renderList();closeModal();
}

function editBot(e,id){e.stopPropagation();openModal(id);}
function delBot(e,id){
  e.stopPropagation();
  const b=bots.find(x=>x.id===id);if(!b)return;
  if(!confirm(`X√≥a bot "${b.name}"?`))return;
  bots=bots.filter(x=>x.id!==id);delete hist[id];
  saveBots();saveHist();
  if(cur?.id===id){
    cur=null;am=null;
    document.getElementById('hName').textContent='Ch·ªçn m·ªôt bot';
    document.getElementById('hModel').textContent='ƒë·ªÉ b·∫Øt ƒë·∫ßu chat';
    document.getElementById('hIcon').textContent='ü§ñ';
    document.getElementById('mselWrap').style.display='none';
    document.getElementById('messages').innerHTML='<div class="welcome"><div class="welcome-icon">‚ö°</div><h2>AI Hub c·ªßa b·∫°n</h2><p>Ch·ªçn bot t·ª´ sidebar ho·∫∑c t·∫°o bot m·ªõi.</p></div>';
  }
  renderList();toast('üóë ƒê√£ x√≥a '+b.name,'ok');
}

function hk(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}}
function ar(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function toast(msg,type='ok'){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className=`toast ${type} show`;
  setTimeout(()=>t.classList.remove('show'),2800);
}
document.getElementById('ov').addEventListener('click',function(e){if(e.target===this)closeModal();});
init();
</script>
</body>
</html>
